<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>RabbitMQ Bindings Diagram</title>
    <script src="script.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.2.1/dist/mermaid.esm.min.mjs';

        mermaid.initialize({startOnLoad: false});

        async function loadDefinitions() {
            return fetchRabbitDefinitions({
                url: document.getElementById("rabbitUrl").value,
                username: document.getElementById('rabbitUsername').value,
                password: document.getElementById('rabbitPassword').value
            });
        }

        function renderDiagramToHtml(mermaidText) {
            return renderDiagram(mermaid, mermaidText)
                .then(result => document.getElementById("mermaidDiagramArea").innerHTML = result);
        }

        async function parseDefinitionsText() {
            try {
                return JSON.parse(document.getElementById("definitionsJson").value);
            } catch (cause) {
                throw new Error("JSONã¸ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚", {cause});
            }
        }

        function logAndAlert(error) {
            console.error(error);
            alert(error.message);
        }

        document.getElementById('renderDiagram').addEventListener("click", () => {
            return renderDiagramToHtml(document.getElementById("mermaidText").value)
                .catch(logAndAlert);
        });
        document.getElementById('definitionsToMermaidText').addEventListener("click", () => {
            parseDefinitionsText()
                .then(definitionsToMermaidText)
                .then(result => document.getElementById("mermaidText").value = result)
                .catch(logAndAlert);
        });
        document.getElementById('definitionsToDiagram').addEventListener("click", () => {
            parseDefinitionsText()
                .then(definitionsToMermaidText)
                .then(renderDiagramToHtml)
                .catch(logAndAlert);
        });
        document.getElementById('loadDefinitions').addEventListener("click", () => {
            loadDefinitions()
                .then(json => document.getElementById('definitionsJson').value = JSON.stringify(json, null, "  "))
                .catch(logAndAlert);
        });
        document.getElementById('loadDefinitionsToDiagram').addEventListener("click", () => {
            loadDefinitions()
                .then(definitionsToMermaidText)
                .then(renderDiagramToHtml)
                .catch(logAndAlert);
        });

        // ã‚µãƒ³ãƒ—ãƒ«ã®å‡ºåŠ›
        document.getElementById('mermaidText').value = "graph LR;\n  exchange -->|routing key| queue";
        document.getElementById('definitionsJson').value = JSON.stringify(
            {
                exchanges: [
                    {name: "my.exchange1"},
                    {name: "my.exchange2"}
                ],
                queues: [
                    {name: "my.queue1"},
                    {name: "my.queue2"},
                    {name: "my.queue3"}
                ],
                bindings: [
                    {
                        "source": "my.exchange1",
                        "vhost": "/",
                        "destination": "my.queue1",
                        "destination_type": "queue",
                        "routing_key": "",
                        "arguments": {},
                        "properties_key": "~"
                    },
                    {
                        "source": "my.exchange1",
                        "vhost": "/",
                        "destination": "my.queue2",
                        "destination_type": "queue",
                        "routing_key": "hoge",
                        "arguments": {},
                        "properties_key": "~"
                    }
                ]
            }
            , null, "  ");

    </script>
    <link href="style.css" rel="stylesheet">
</head>

<body>
<details open>
    <summary>CONTROL</summary>
    <div class="controls">
        <div class="control">
            <h2>Mermaid</h2>
            <div class="source">
                <textarea id="mermaidText"></textarea>
            </div>
            <button id="renderDiagram">ğŸ¨render</button>
            <details class="hint">
                <ul>
                    <li>Mermaidã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</li>
                    <li>renderãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä¸‹ã«ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                    <li>å‡ºåŠ›ã‚’èª¿æ•´ã—ãŸã„å ´åˆã¯ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</li>
                </ul>
            </details>
        </div>

        <div class="control">
            <h2>Definitions</h2>
            <div class="source">
                <textarea id="definitionsJson"></textarea>
            </div>
            <button id="definitionsToMermaidText">â—€ï¸mermaid</button>
            <button id="definitionsToDiagram">ğŸ¨render</button>
            <details class="hint">
                <ul>
                    <li><code>{rabbitMQ}/api/definitions</code> ã§å–å¾—ã§ãã‚‹JSONã§ã™ã€‚</li>
                    <li>RabbitMQã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®Overviewã«ã‚ã‚‹ <i>Export definitions</i> ã‹ã‚‰ã‚‚å–å¾—ã§ãã¾ã™ã€‚</li>
                    <li>renderãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä¸‹ã«ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                    <li>mermaidãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨Mermaidã‚³ãƒ¼ãƒ‰ã‚’ç½®ãæ›ãˆã¾ã™ã€‚</li>
                </ul>
            </details>
        </div>

        <div class="control">
            <h2>RabbitMQ</h2>
            <div class="source">
                <label>url: <input type="text" id="rabbitUrl" value="http://localhost:15672"></label>
                <label>username: <input type="text" id="rabbitUsername" value="guest"></label>
                <label>password: <input type="password" id="rabbitPassword" value="guest"></label>
            </div>
            <button id="loadDefinitions">â—€ï¸definitions</button>
            <button id="loadDefinitionsToDiagram">ğŸ¨render</button>
            <details class="hint">
                <ul>
                    <li>RabbitMQã®ç®¡ç†APIã‚’ä½¿ç”¨ã—ã¦å®šç¾©ã‚’å–å¾—ã—ã¾ã™ã€‚</li>
                    <li><a href="https://www.rabbitmq.com/docs/management#cors">RabbitMQã®CORS</a>ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ãªã„å ´åˆã¯å‘¼ã³å‡ºã›ã¾ã›ã‚“ã€‚ç„¡åŠ¹ã«ã™ã‚‹ãªã‚Šãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹ãªã‚Šã€ãªã‚“ã‚‰ã‹ã®æ–¹æ³•ã§ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚</li>
                    <li>ç„¡ç†ãªã‚‰è«¦ã‚ã¦Definitionsã‚’å–ã£ã¦ãã¾ã—ã‚‡ã†ã€‚</li>
                    <li>renderãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä¸‹ã«ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                    <li>definitionsãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨Definitionsã‚’ç½®ãæ›ãˆã¾ã™ã€‚</li>
                </ul>
            </details>
        </div>
    </div>
</details>

<div id="mermaidDiagramArea" class="diagram"></div>
</body>

</html>