<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>RabbitMQ Bindings Diagram</title>
    <script src="script.js"></script>
    <script type="module">
        // Mermaidの初期化
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.2.1/dist/mermaid.esm.min.mjs';

        mermaid.initialize({startOnLoad: false});

        async function loadDefinitions() {
            return fetchRabbitDefinitions({
                url: document.getElementById("rabbitUrl").value,
                username: document.getElementById('rabbitUsername').value,
                password: document.getElementById('rabbitPassword').value
            });
        }

        function renderDiagramToHtml(mermaidText) {
            return renderDiagram(mermaid, mermaidText)
                .then(result => document.getElementById("mermaidDiagramArea").innerHTML = result);
        }

        function definitionsTextToMermaidText() {
            return definitionsToMermaidText(JSON.parse(document.getElementById("definitionsJson").value));
        }

        document.getElementById('renderDiagram').addEventListener("click", () => {
            return renderDiagramToHtml(document.getElementById("mermaidText").value)
                .catch(error => console.log(error));
        });
        document.getElementById('definitionsToMermaidText').addEventListener("click", () => {
            definitionsTextToMermaidText()
                .then(result => document.getElementById("mermaidText").value = result)
                .catch(error => console.log(error));
        });
        document.getElementById('definitionsToDiagram').addEventListener("click", () => {
            definitionsTextToMermaidText()
                .then(result => renderDiagramToHtml(result))
                .catch(error => console.log(error));
        });
        document.getElementById('loadDefinitions').addEventListener("click", () => {
            loadDefinitions()
                .then(json => document.getElementById('definitionsJson').value = JSON.stringify(json, null, "  "));
        });
        document.getElementById('loadDefinitionsToDiagram').addEventListener("click", () => {
            loadDefinitions()
                .then(result => definitionsToMermaidText(result))
                .then(result => renderDiagramToHtml(result))
                .catch(error => console.log(error));
        });

        // サンプルの出力
        document.getElementById('mermaidText').value = "graph LR; exchange -->|routing key| queue";
        document.getElementById('definitionsJson').value = JSON.stringify({
            bindings: [
                {
                    "source": "my.exchange",
                    "vhost": "/",
                    "destination": "my.queue1",
                    "destination_type": "queue",
                    "routing_key": "",
                    "arguments": {},
                    "properties_key": "~"
                },
                {
                    "source": "my.exchange",
                    "vhost": "/",
                    "destination": "my.queue2",
                    "destination_type": "queue",
                    "routing_key": "hoge",
                    "arguments": {},
                    "properties_key": "~"
                }
            ]
        }, null, "  ");

    </script>
    <link href="style.css" rel="stylesheet">
</head>

<body>
<h1>RabbitMQ Bindings Diagram</h1>
<div id="mermaidDiagramArea">ここに表示されます</div>

<div class="control">
    <button id="renderDiagram">↑</button>

    <div class="source">
        <h2>Mermaid Text</h2>
        <textarea id="mermaidText"></textarea>
    </div>
</div>

<div class="control">
    <button id="definitionsToMermaidText">↑</button>
    <button id="definitionsToDiagram">↑↑</button>

    <div class="source">
        <h2>RabbitMQ Definitions(JSON)</h2>
        <textarea id="definitionsJson"></textarea>
    </div>
</div>

<div class="control">
    <button id="loadDefinitions">↑</button>
    <button id="loadDefinitionsToDiagram">↑↑↑</button>

    <div class="source">
        <h2>RabbitMQ</h2>
        <label>url: <input type="text" id="rabbitUrl" value="http://localhost:8080"></label>
        <label>username: <input type="text" id="rabbitUsername" value="guest"></label>
        <label>password: <input type="password" id="rabbitPassword" value="guest"></label>
    </div>
</div>
</body>

</html>